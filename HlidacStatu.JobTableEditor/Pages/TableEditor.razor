@page "/tableEditor"

@using HlidacStatu.JobTableEditor.Data
@using HlidacStatu.JobTableEditor.Components
@using HlidacStatu.Entities
@using System.Threading
@using HlidacStatu.DetectJobs
@using HlidacStatu.Repositories.Exceptions

@inject JobService JobService
@inject AuthenticationStateProvider AuthenticationStateProvider

@attribute [Authorize(Roles = "Admin,TableEditor")]

<h1>Job editor</h1>

<div class="container">
    <div class="row">
        <div class="col-2 bg-primary bg-opacity-25">
            Pozice
        </div>
        <div class="col-2 bg-success bg-opacity-25">
            Cena za MD bez DPH
        </div>
        <div class="col-2 bg-warning bg-opacity-25">
            Cena za MD s DPH
        </div>
    </div>
</div>
<hr style="margin-bottom: 20px;"/>

@if (table == null)
{
    if (hlaska is not null)
    {
        <h4>
            @hlaska.Value
        </h4>
    }
    <p>
        <label for="specificLoad">Načíst konkrétní tabulku</label>
        <input id="specificLoad" type="number" @bind="tablePk"/>
        <button class="btn btn-primary" @onclick="LoadNewTable">Načti tabulku</button>
    </p>

}
else
{
    <h4 class="text-danger">@errorMessage</h4>
    <button class="btn btn-secondary btn-sm" @onclick="MultiplyPrices">Vynásob ceny 8</button>
    <button class="btn btn-secondary btn-sm" @onclick="AddColumn">Přidej sloupec</button>
    <button class="btn btn-secondary btn-sm" @onclick="AddRow">Přidej řádek</button>
    <a class="btn btn-outline-secondary btn-sm" target="_blank" href="https://www.hlidacstatu.cz/manage/ShowPrilohaTablesOnePage?s=@(table.InDocTable.SmlouvaID)&p=@(table.InDocTable.PrilohaHash)&page=@table.InDocTable.Page"><i class="far fa-file-alt"></i>Ukázat stránku s tabulkou</a>
    <span>&nbsp;&nbsp;| &nbsp;</span>
    <button class="btn btn-outline-success" @onclick="SaveTable">Save changes</button>
    <button class="btn btn-outline-warning" @onclick="SuperviseTable">Send to supervisor</button>
    <button class="btn btn-outline-danger" @onclick="NonsenseTable">This table is full of 💩</button>
    <hr style="margin-bottom:20px;"/>
    <table class="table">
        <thead>
        <tr>
            @for (int col = 0; col < table.Cells[0].Length; col++)
            {
                int column = col;
                <th>
                    <button class="btn btn-sm btn-primary bg-opacity-25" @onclick="@(() => SetColumn(column, InTables.Cell.GuessedCellType.Position) )">Job</button>
                    <button class="btn btn-sm btn-success bg-opacity-25" @onclick="@(() => SetColumn(column, InTables.Cell.GuessedCellType.Price) )"><i class="far fa-money-bill-alt"></i></button>
                    <button class="btn btn-sm btn-warning bg-opacity-25" @onclick="@(() => SetColumn(column, InTables.Cell.GuessedCellType.PriceWithVAT) )"><i class="far fa-money-bill-alt"></i> s DPH</button>
                    <button class="btn btn-sm btn-outline-info" @onclick="@(() => SetColumn(column, InTables.Cell.GuessedCellType.Unknown) )">Nic</button>
                </th>
            }
        </tr>
        </thead>
        <tbody>
        @foreach (var row in table.Cells)
        {
            <tr>
                @foreach (var cell in row)
                {
                    <Cell CellShell="@cell" Swapper="@Swapper"></Cell>
                }
            </tr>
        }
        </tbody>
    </table>
    <hr style="margin-top:20px;"/>
    <button class="btn btn-secondary" @onclick="MultiplyPrices">Vynásob ceny 8</button>
    <a class="btn btn-outline-secondary" target="_blank" href="https://www.hlidacstatu.cz/manage/ShowPrilohaTablesOnePage?s=@(table.InDocTable.SmlouvaID)&p=@(table.InDocTable.PrilohaHash)&page=@table.InDocTable.Page"><i class="far fa-file-alt"></i>Ukázat stránku s tabulkou</a>
    <span>&nbsp;&nbsp;| &nbsp;</span>
    <button class="btn btn-outline-success" @onclick="SaveTable">Save changes</button>
    <button class="btn btn-outline-warning" @onclick="SuperviseTable">Send to supervisor</button>
    <button class="btn btn-outline-danger" @onclick="NonsenseTable">This table is full of 💩</button>

    <hr/>
    
}

@code {
    private SomeTable table;
    private DateTime tableOpenedAt;
    private string errorMessage;
    private CellSwapper Swapper { get; } = new CellSwapper();
    
    private MarkupString? hlaska;
    private int processedTables;

    private int tablePk;

    private void SetColumn(int column, InTables.Cell.GuessedCellType cellType)
    {
        foreach (var row in table.Cells)
        {
            row[column].CellType = cellType;
        }
        
    //StateHasChanged();
    }

    private async Task LoadNewTable()
    {
        hlaska = null;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState?.User?.Identity?.Name;

        if (tablePk != 0)
        {
            table = await JobService.GetSpecificTable(tablePk, userName, CancellationToken.None);
        }
        else
        {

            try
            {
                table = await JobService.GetNewTable(userName, CancellationToken.None);
            }
            catch (NoDataFoundException ndfe)
            {
                hlaska = new MarkupString($"<div class=\"alert alert-warning\" role=\"alert\">Ve frontě už není žádná další tabulka ke zpracování.</div>");
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                throw;
            }
        }
        tableOpenedAt = DateTime.Now;
    }

    private async Task SaveTable()
    {
        var isSaved = await TrySave(InDocTables.CheckStatuses.Done);
        if (isSaved)
        {
            await OnSaved();
        }
    }

    private async Task SuperviseTable()
    {
        var isSaved = await TrySave(InDocTables.CheckStatuses.ForNextReview);
        if (isSaved)
        {
            await OnSaved();
        }
    }

    private async Task NonsenseTable()
    {
        var isSaved = await TrySave(InDocTables.CheckStatuses.WrongTable);
        if (isSaved)
        {
            await OnSaved();
        }
    }

    private readonly string[] pochvaly = new string[]
    {
        "Dobrá práce!",
        "Šikula!",
        "Tobě to jde!",
        "Je radost s tebou spolupracovat!",
        "Boží <i class=\"fad fa-heart\"></i>"
    };
    private async Task OnSaved()
    {
        table = null;
        errorMessage = "";
        processedTables++;

        try
        {
            switch (processedTables % 100)
            {
                case 20:
                    hlaska = new MarkupString("Zasloužíš si <i class=\"fad fa-mug-hot\"></i>");
                    return;
                case 40:
                    hlaska = new MarkupString("<i class=\"fal fa-smoking\"></i> Pauzu?");
                    return;
                case 60:
                    hlaska = new MarkupString("Nemáš hlad <i class=\"fal fa-cookie\"></i>");
                    return;
                case 80:
                    hlaska = new MarkupString("<i class=\"fad fa-running\"></i> Co se takhle trochu protáhnout?");
                    return;
                case 99:
                    hlaska = new MarkupString("Tvůj dnešní výkon je na <i class=\"fad fa-medal\"></i>");
                    return;
                default:
                    break;
            }

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userName = authState?.User?.Identity?.Name;
            var randomStatistic = await JobService.GetRandomStatistic(userName, CancellationToken.None);
            hlaska = new MarkupString($"{pochvaly[processedTables % (pochvaly.Length)]} <br/> {randomStatistic}");
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            hlaska = new MarkupString($"Nepodařilo se mi vymyslet správnou hlášku. Omlouvám se... <br/> Chyba je v {e.Message}");
        }

    }
    
    private async Task<bool> TrySave(InDocTables.CheckStatuses operation)
    {
        var elapsedTime = DateTime.Now - tableOpenedAt;
        table.ProcessingTime = elapsedTime;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState?.User?.Identity?.Name;
        table.Author = userName;

        try
        {
            await JobService.SaveChanges(table, operation);
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            errorMessage = e.Message;
            return false;
        }

        return true;
    }
    
    private void MultiplyPrices()
    {
        foreach (var row in table.Cells)
        {
            foreach (var cell in row)
            {
                if (cell.CellType == InTables.Cell.GuessedCellType.Price
                    || cell.CellType == InTables.Cell.GuessedCellType.PriceWithVAT)
                {
                    var newPrice = (Devmasters.ParseText.ToDecimal(cell.Value) * 8);
                    cell.Value = newPrice.HasValue ? newPrice.Value.ToString("N2") : "";
                }
            }
        }
    }

    private void AddColumn()
    {
        for (int i = 0; i < table.Cells.Length; i++)
        {
            int currentLength = table.Cells[i].Length;
            Array.Resize(ref table.Cells[i], currentLength + 1);
            table.Cells[i][currentLength] = new CellShell(new InTables.Cell(), i, currentLength);
        }
        
    }
    
    private void AddRow()
    {
        var oldArray = table.Cells;
        table.Cells = new CellShell[oldArray.Length + 1][];
        for (int row = 0; row < oldArray.Length; row++) {
            table.Cells[row] = oldArray[row]; 
        }

        int columnCount = table.Cells[0].Length;
        int lastRow = table.Cells.Length - 1;
        table.Cells[lastRow] = new CellShell[columnCount];
        for (int col = 0; col < columnCount; col++)
        {
            table.Cells[lastRow][col] = new CellShell(new InTables.Cell(), lastRow, col);
        }
        
    }

}

