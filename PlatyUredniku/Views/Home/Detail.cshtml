@using MathNet.Numerics.Statistics
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using PlatyUredniku.Models
@model HlidacStatu.Entities.Entities.PuOrganizace

@section scripts
{
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
        function adjustDataTablesWidth() {
                $.fn.dataTable.tables({visible: true, api: true}).columns.adjust();   
            }
    </script>
}

@section breadcrumbs
{
    <ol class="breadcrumb">
        <li>
            <a asp-action="Index">Platy úředníků</a>
        </li>
        <li>
            <a asp-action="Oblasti">Oblasti</a>
        </li>
        <li>
            <hashtag tag="@ViewData["mainTag"]"></hashtag>
        </li>
        <li class="active">@Model.Nazev</li>
    </ol>
}

<section class="d-flex align-items-center justify-content-center">
    <div class="container">


        <h2 class="pb-2 border-bottom">@Model.Nazev</h2>
        <p>
            IČO: <a href="https://www.hlidacstatu.cz/subjekt/@(Model.Ico)" target=”_blank”>@Model.Ico<i class="fa-solid fa-arrow-up-right-from-square"></i></a> <br/>
            Datová schránka: @Model.DS <br/>
        </p>
        <div>
            @foreach (var tag in Model.Tags)
            {
                <hashtag tag="@tag.Tag"></hashtag>
            }
        </div>

        @{
            var salariesYearly = Model.Platy
                .GroupBy(p => p.Rok, p => p)
                .OrderBy(k => k.Key)
                .ToDictionary(g => g.Key, g => g.Select(x => x).ToList());

            if (salariesYearly.Any())
            {
                Dictionary<int, AreaRangePlot.PlotData?> plotData = new();

                for (int year = salariesYearly.Keys.Min(); year <= salariesYearly.Keys.Max(); year++)
                {
                    AreaRangePlot.PlotData? dataForYear = new AreaRangePlot.PlotData();

                    if (salariesYearly.TryGetValue(year, out var platyForYear))
                    {
                        var hrubeMesicniPlaty = platyForYear
                            .Select(p => (double)p.HrubyMesicniPlat)
                            .ToList();
                        dataForYear.Median = hrubeMesicniPlaty?.Median() ?? null;
                        dataForYear.Min = hrubeMesicniPlaty?.Min() ?? null;
                        dataForYear.Max = hrubeMesicniPlaty?.Max() ?? null;

                        var hrubeMesicniPlatyCeo = platyForYear
                            .Where(p => p.JeHlavoun == true)
                            .Select(p => (double)p.HrubyMesicniPlat);
                        if (hrubeMesicniPlatyCeo.Any())
                        {
                            dataForYear.Ceo = hrubeMesicniPlatyCeo.Average();
                        }
                    }

                    plotData.Add(year, dataForYear);
                }

                var graphData = new AreaRangePlot()
                {
                    Title = "Vývoj platů",
                    Subtitle = "vývoj průměrného platu po letech",
                    Values = plotData
                };
                <partial name="Graphs/_AreaRangePlot" model="graphData"/>
            }
        }
    </div>
</section>

@if (Model.Metadata.Any())
{
    <section class="d-flex justify-content-center alter-bg-color">
        <div class="container">
            <h3>Detaily komunikace instituce ohledně platů</h3>
            <div class="nav flex-row nav-pills my-5" id="v-meta-pills-tab" role="tablist">
                <button class="nav-link disabled" type="button" disabled="disabled">Rok</button>
                @{
                    string metadataClassAttributes = "nav-link active";

                    foreach (var metadata in Model.Metadata.OrderByDescending(m => m.Rok))
                    {
                        <button class="@metadataClassAttributes"
                                id="meta-year-@metadata.Rok-tab"
                                data-bs-toggle="pill"
                                data-bs-target="#meta-year-@metadata.Rok"
                                type="button"
                                role="tab">
                            @metadata.Rok
                        </button>

                        metadataClassAttributes = "nav-link";
                    }
                }
            </div>
            <div class="tab-content width-75vp">
                @{
                    metadataClassAttributes = "tab-pane width-75vp fade show active";

                    foreach (var metadataForYear in Model.Metadata.OrderByDescending(m => m.Rok))
                    {
                        <div class="@metadataClassAttributes" id="meta-year-@metadataForYear.Rok" role="tabpanel">
                            <div>
                                <div class="row g-4 py-5 row-cols-1 row-cols-lg-3">
                                    <div class="col d-flex align-items-start">
                                        <div class="icon-square text-body-emphasis bg-body-secondary d-inline-flex align-items-center justify-content-center fs-4 flex-shrink-0 me-3">
                                            <svg class="bi" width="1em" height="1em">
                                                <use xlink:href="#toggles2"></use>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="fw-bold">Doba trvání</h4>
                                            <p>
                                                Žádost o výši platů jsme odeslali @(metadataForYear.DatumOdeslaniZadosti?.ToString("dd.MM.yyyy"))
                                                @if (metadataForYear.DatumPrijetiOdpovedi.HasValue)
                                                {
                                                    <span>
                                                        a odpověď obdrželi po
                                                        @(Devmasters.Lang.CS.Plural.Get((int)(metadataForYear.DatumPrijetiOdpovedi.Value - metadataForYear.DatumOdeslaniZadosti.Value).TotalDays, "jednom dni", "{0} dnech", "{0} dnech")).
                                                    </span>
                                                }
                                            </p>
                                        </div>
                                    </div>

                                    <div class="col d-flex align-items-start">
                                        <div class="icon-square text-body-emphasis bg-body-secondary d-inline-flex align-items-center justify-content-center fs-4 flex-shrink-0 me-3">
                                            <svg class="bi" width="1em" height="1em">
                                                <use xlink:href="#cpu-fill"></use>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="fw-bold">Zdůvodnění mimořádných odměn</h4>
                                            <p>Součástí naší žádosti byl požadavek na zaslání odůvodnění mimořádných odměn pracovníků. Toto odůvodnění jsme @(metadataForYear.ZduvodneniMimoradnychOdmen == true ? "dostali" : "nedostali").</p>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(metadataForYear.SkrytaPoznamka))
                                    {
                                        <div class="col d-flex align-items-start">
                                            <div class="icon-square text-body-emphasis bg-body-secondary d-inline-flex align-items-center justify-content-center fs-4 flex-shrink-0 me-3">
                                                <svg class="bi" width="1em" height="1em">
                                                    <use xlink:href="#cpu-fill"></use>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="fw-bold">Poznámka Hlídače</h4>
                                                <p>@metadataForYear.SkrytaPoznamka</p>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        metadataClassAttributes = "tab-pane width-75vp";
                    }
                }
            </div>
        </div>
    </section>
}

@{
    var platyPoLetech = Model.Platy.GroupBy(p => p.Rok).OrderByDescending(pg => pg.Key).ToList();
}

<section class="d-flex justify-content-center @(Model.Metadata.Any()? "":"alter-bg-color")">
    <div class="container">
        <h3>Přehled platů</h3>
        <div class="nav flex-row nav-pills my-5" id="v-pills-tab" role="tablist">
            <button class="nav-link disabled" type="button" disabled="disabled">Rok</button>
            @{
                string classAttributes = "nav-link active";

                foreach (var platRok in platyPoLetech)
                {
                    <button class="@classAttributes"
                            id="year-@platRok.Key-tab"
                            data-bs-toggle="pill"
                            data-bs-target="#year-@platRok.Key"
                            type="button"
                            role="tab"
                            onclick="adjustDataTablesWidth()">
                        @platRok.Key
                    </button>

                    classAttributes = "nav-link";
                }
            }
        </div>
        <div class="tab-content width-75vp">
            @{
                classAttributes = "tab-pane width-75vp fade show active";

                foreach (var platGroup in platyPoLetech)
                {
                    <div class="@classAttributes" id="year-@platGroup.Key" role="tabpanel">
                        <script>
                            $(document).ready(function () {
                                $('#tblSum_@platGroup.Key').DataTable(
                                    {
                                        'language': {
                                            'url': '//cdn.datatables.net/plug-ins/1.13.4/i18n/cs.json'
                                        },
                                        "searching": false,
                                        "paging": false,
                                        "ordering": true,
                                        "order": [],
                                        "scrollCollapse": true,
                                        "scrollY": '50vh',
                                        "info": false
                                    });
                            });
                        </script>

                        <table class="table table-borderless table-hover" id="tblSum_@platGroup.Key">
                            <thead>
                            <tr>
                                <th>Název pozice</th>
                                <th>Celkový roční<br/>příjem</th>
                                <th>Přepočtený průměrný<br/>měsíční plat</th>
                                <th>Nefinanční bonus</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var plat in platGroup.OrderBy(p => p.DisplayOrder).ThenBy(p => p.NazevPozice))
                            {
                                <tr>
                                    <td>
                                        <a asp-action="Plat" asp-route-id="@plat.Id">@plat.NazevPozice</a>
                                    </td>
                                    <td data-order="@(HlidacStatu.Util.RenderData.OrderValueFormat(plat.CelkovyRocniPlat))" class="number">@HlidacStatu.Util.RenderData.NicePrice(plat.CelkovyRocniPlat)</td>
                                    <td data-order="@(HlidacStatu.Util.RenderData.OrderValueFormat(plat.HrubyMesicniPlat))" class="number">@HlidacStatu.Util.RenderData.NicePrice(plat.HrubyMesicniPlat)</td>
                                    <td>@plat.NefinancniBonus</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                    classAttributes = "tab-pane width-75vp";
                }
            }
        </div>
        <partial name="ExportModal" model="@(new ExportModalViewModel() { DatovaSchranka = Model.DS, Titulek = $"Export dat pro {Model.Nazev}" })"/>
    </div>
</section>