@using Devmasters.Enums
@using HlidacStatu.Entities
@using HlidacStatu.Repositories
@using HlidacStatu.XLib.Render
@model List<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>

@{
    ViewBag.Title = "Hlídač dotací";
    ViewBag.SubTitle = "Report po kategoriích a letech";
}

@section breadcrumb
{
    <ol class="breadcrumb">
        <li>
            <a href="/">Hlídač Státu</a>
        </li>
        <li>
            <a href="@Url.Action("Index", "Dotace")">Dotace</a>
        </li>
        <li class="active">@ViewBag.SubTitle</li>
    </ol>
}

@section scripts
{
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.13.4/css/jquery.dataTables.css"/>
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
    <script src="~/bundles/highcharts"></script>
}

@foreach (var category in Model.Select(m => m.Category).Distinct().OrderBy(m => m))
{
    var data = new ReportDataSource<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>(
        new[]
        {
            new ReportDataSource<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>.Column()
            {
                Name = "Rok",
                CssClass = "number",
                HtmlRender = (x) => x.Year.ToString(),
                TextRender = (x) => x.Year.ToString()
            },
            new ReportDataSource<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>.Column()
            {
                Name = "Kategorie",
                CssClass = "text",
                HtmlRender = (x) => $"<a href=/dotace/hledat?Q=hints.category1.typeValue:{x.Category:D}>{x.Category.ToNiceDisplayName()}</a>",
                TextRender = (x) => x.Ico
            },
            new ReportDataSource<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>.Column()
            {
                Name = "IČO",
                CssClass = "text",
                HtmlRender = (x) => $"<a href=/subjekt/{x.Ico}>{x.Ico}</a>",
                TextRender = (x) => x.Ico
            },
            new ReportDataSource<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>.Column()
            {
                Name = "Název příjemce",
                CssClass = "text",
                HtmlRender = (x) => $"{FirmaRepo.NameFromIco(x.Ico)}</a>",
                TextRender = (x) => x.Ico
            },
            new ReportDataSource<(string Ico, int Year, Subsidy.Hint.CalculatedCategories Category, decimal Sum)>.Column()
            {
                Name = "Částka",
                TextRender = (x) => $"{x.Sum:N0} Kč",
                HtmlRender = (x) => $"<a href=/dotace/hledat?Q=Ico:{x.Ico}>{x.Sum:N0}&nbsp;Kč</a>",
                OrderValueRender = (x) => HlidacStatu.Util.RenderData.OrderValueFormat(x.Sum),
                CssClass = "number"
            }
        });
    
    for (var year = 2021; year < DateTime.Now.Year; year++)
    {
        data.AddRows(Model.Where(m => m.Year == year && m.Category == category).ToList());
    }
    
    
    <h4>@category.ToNiceDisplayName()</h4>
    <div>
        @Html.DataToHTMLTable(data)
    </div>
}

