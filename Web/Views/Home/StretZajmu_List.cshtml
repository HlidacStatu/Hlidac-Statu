@model (List<OsobaStret> strety, string nameId, string paragraf)

@using HlidacStatu.DS.Graphs
@using HlidacStatu.Entities
@using HlidacStatu.Lib.Analytics
@using HlidacStatu.Repositories
@using HlidacStatu.Repositories.Analysis
@using HlidacStatu.Repositories.StretZajmu
@using HlidacStatu.XLib;

@{
    ViewBag.Title = "Analýza střetu zájmů dle zákona o střetu zájmů";
    ViewBag.SubTitle = "";

    var strety = Model.strety;
    var nameId = Model.nameId;
    var paragraf = Model.paragraf;

    var withConflict = strety
        .Where(m => m.Stat_SmlouvyCount + m.Stat_DotaceCount > 0)
        .GroupBy(os => os.Osoba_with_Event.Osoba.NameId, (k, v) => new { NameId = k, osoba_strety = v })
        .ToList();

    var withoutConflict = strety
        .Where(m => m.Stat_SmlouvyCount + m.Stat_DotaceCount == 0)
        .OrderBy(o => o.Osoba_with_Event.Osoba.Prijmeni)
        .ThenBy(o => o.Osoba_with_Event.Osoba.Jmeno)
        .ToList();

    var totalSmlouvyCount = strety.Where(m => m.Stat_SmlouvyCount > 0).Sum(m => m.Stat_SmlouvyCount);
    var totalSmlouvySum = strety.Where(m => m.Stat_SmlouvySum > 0).Sum(m => m.Stat_SmlouvySum);
    var totalDotaceCount = strety.Where(m => m.Stat_DotaceCount > 0).Sum(m => m.Stat_DotaceCount);
    var totalDotaceSum = strety.Where(m => m.Stat_DotaceSum > 0).Sum(m => m.Stat_DotaceSum);
}

@section breadcrumb
{
    <ol class="breadcrumb">
        <li><a href="/">Hlídač Státu</a></li>
        <li class="active">@ViewBag.Title</li>
    </ol>
}

<h2>Analýza střetu zájmů dle § @paragraf</h2>
<p class="mt-2 mb-4">U následujících osob jsme nalezli možný střet zájmu dle zákona o střetu zájmů.</p>

@* Summary stats *@
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="card-title mb-1">@withConflict.Count</h3>
                <p class="card-text text-muted mb-0">osob s nalezeným střetem</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="card-title mb-1">@Html.Raw(HlidacStatu.Util.RenderData.NiceNumber(totalSmlouvyCount, true))</h3>
                <p class="card-text text-muted mb-0">
                    smluv ve střetu<br />
                    celkem @Html.Raw(HlidacStatu.Util.RenderData.ShortNicePrice(totalSmlouvySum, html: true, mena: "")) Kč
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="card-title mb-1">@Html.Raw(HlidacStatu.Util.RenderData.NiceNumber(totalDotaceCount, true))</h3>
                <p class="card-text text-muted mb-0">
                    dotací ve střetu<br />
                    celkem @Html.Raw(HlidacStatu.Util.RenderData.ShortNicePrice(totalDotaceSum, html: true, mena: "")) Kč
                </p>
            </div>
        </div>
    </div>
</div>

@* Person cards *@
@foreach (var personData in withConflict)
{
    var osobaStrety = personData.osoba_strety;
    var person = await HlidacStatu.Repositories.Cache.OsobaCache.GetPersonByNameIdAsync(personData.NameId);

    var personSmlouvyCount = osobaStrety.Sum(o => o.Stat_SmlouvyCount);
    var personSmlouvySum = osobaStrety.Sum(o => o.Stat_SmlouvySum);
    var personDotaceCount = osobaStrety.Sum(o => o.Stat_DotaceCount);
    var personDotaceSum = osobaStrety.Sum(o => o.Stat_DotaceSum);

    <div class="card mb-3">
        <div class="card-header d-flex align-items-center">
            @if (person.HasPhoto())
            {
                <img src="@person.GetPhotoUrl()" alt="@person.FullName()"
                     class="rounded-circle me-3" style="width:40px;height:40px;object-fit:cover" />
            }
            <h4 class="mb-0">
                <a href="/osoba/@person.NameId" class="text-decoration-none">@person.FullNameWithYear()</a>
            </h4>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Role</th>
                            <th>Úřad</th>
                            <th class="text-end">Smlouvy</th>
                            <th class="text-end">Dotace</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var os in osobaStrety
                                    .Where(m => m.Stat_SmlouvyCount + m.Stat_DotaceCount > 0)
                                    .OrderByDescending(o => o.Stat_SmlouvySum + o.Stat_DotaceSum)
                                    .ThenByDescending(o => o.Stat_SmlouvyCount + o.Stat_DotaceCount))
                        {
                            var firmaJmeno = await HlidacStatu.Repositories.Cache.FirmaCache.GetJmenoAsync(os.Osoba_with_Event.Event.Ico);
                            <tr>
                                <td>
                                    @os.Osoba_with_Event.Event.AddInfo
                                    <br />
                                    <small class="text-muted">@(os.Stret_za_obdobi.ToNiceString(dateFormat: "d.M.yyyy", noValue: ""))</small>
                                </td>
                                <td>@firmaJmeno</td>
                                <td class="text-end text-nowrap">
                                    @Html.Raw(HlidacStatu.Util.RenderData.NiceNumber(os.Stat_SmlouvyCount, true)) ks /
                                    @Html.Raw(HlidacStatu.Util.RenderData.ShortNicePrice(os.Stat_SmlouvySum, html: true, mena: "")) Kč
                                </td>
                                <td class="text-end text-nowrap">
                                    @Html.Raw(HlidacStatu.Util.RenderData.NiceNumber(os.Stat_DotaceCount, true)) ks /
                                    @Html.Raw(HlidacStatu.Util.RenderData.ShortNicePrice(os.Stat_DotaceSum, html: true, mena: "")) Kč
                                </td>
                                <td class="text-end">
                                    <a class="btn btn-primary btn-sm" href="/stretzajmu/@os.Id">Detail</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                    @if (osobaStrety.Count(m => m.Stat_SmlouvyCount + m.Stat_DotaceCount > 0) > 1)
                    {
                        <tfoot class="table-light">
                            <tr class="fw-bold">
                                <td colspan="2">Celkem</td>
                                <td class="text-end text-nowrap">
                                    @Html.Raw(HlidacStatu.Util.RenderData.NiceNumber(personSmlouvyCount, true)) ks /
                                    @Html.Raw(HlidacStatu.Util.RenderData.ShortNicePrice(personSmlouvySum, html: true, mena: "")) Kč
                                </td>
                                <td class="text-end text-nowrap">
                                    @Html.Raw(HlidacStatu.Util.RenderData.NiceNumber(personDotaceCount, true)) ks /
                                    @Html.Raw(HlidacStatu.Util.RenderData.ShortNicePrice(personDotaceSum, html: true, mena: "")) Kč
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    }
                </table>
            </div>
        </div>
    </div>
}

@* No conflict section *@
@if (withoutConflict.Any())
{
    <hr />
    <h2>Osoby bez nalezeného střetu zájmů</h2>
    <p>Tyto osoby jsme analyzovali také a střet zájmů jsme nenalezli.</p>
    <div class="row mt-3 mb-4">
        @foreach (var os in withoutConflict)
        {
            <div class="col-md-4 col-sm-6 mb-1">
                <b>@os.Osoba_with_Event.Osoba.FullName()</b>
                <small class="text-muted">
                    (@os.Osoba_with_Event.Event.AddInfo - @(await HlidacStatu.Repositories.Cache.FirmaCache.GetJmenoAsync(os.Osoba_with_Event.Event.Ico)))
                </small>
            </div>
        }
    </div>
}

@* Law text - collapsible *@
<div class="mt-4">
    <p>
        <a class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" href="#lawTextSection" role="button" aria-expanded="false" aria-controls="lawTextSection">
            Zákon o střetu zájmů dle § @paragraf
        </a>
    </p>
    <div class="collapse" id="lawTextSection">
        <div class="alert alert-info" style="white-space:pre-wrap">
(1) Veřejný funkcionář uvedený v § 2 odst. 1 písm. c) až m) nesmí
a) podnikat nebo provozovat jinou samostatnou výdělečnou činnost,
b) být členem statutárního orgánu, členem řídícího, dozorčího nebo kontrolního orgánu právnické osoby, která podniká (dále jen „podnikající právnická osoba"), pokud zvláštní právní předpis nestanoví jinak, nebo
c) být v pracovněprávním nebo obdobném vztahu nebo ve služebním poměru, nejde-li o vztah nebo poměr, v němž působí jako veřejný funkcionář.

(2) Omezení podle odstavce 1 se nevztahuje na správu vlastního majetku a na činnost vědeckou, pedagogickou, publicistickou, literární, uměleckou nebo sportovní, nejde-li o vlastní podnikání v těchto oborech.

(3) Veřejní funkcionáři uvedení v odstavci 1 jsou povinni činnosti tam uvedené ukončit bez zbytečného odkladu poté, co začali vykonávat svou funkci, nejpozději však do 30 dnů ode dne zahájení výkonu funkce. Není-li k ukončení činnosti z důvodů nezávislých na vůli veřejného funkcionáře možné dodržet lhůtu uvedenou v předchozí větě, veřejný funkcionář o této skutečnosti v dané lhůtě informuje evidenční orgán a provede současně všechna potřebná opatření směřující k ukončení činnosti. Ustanovení zvláštních právních předpisů tím nejsou dotčena4).
        </div>
    </div>
</div>
