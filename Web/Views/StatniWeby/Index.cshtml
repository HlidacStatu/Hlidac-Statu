@using HlidacStatu.Entities

@{
    ViewBag.Title = "Hlídač státních webů";
    ViewBag.SubTitle = "Hlídáme je, jestli běží!";


}
@section scripts
{
<script src="/scripts/highcharts-6/highcharts.js"></script>
<script src="/scripts/highcharts-6/modules/heatmap.js"></script>
<script src="/scripts/highcharts-6/modules/data.js"></script>
<script src="/scripts/highcharts-6/modules/boost-canvas.js"></script>
<script src="/scripts/highcharts-6/modules/boost.js"></script>
    @WebyChartUtil.OnPageSharedJavascript()


}

@*<div class="card bg-danger">
    <div class="card-header">
    <h3 class="card-title">Chyba!</h3>
    </div>
    <div class="card-body">
    Data dostupnosti webů nejsou v tuto chvíli k dispozici. Omlouváme se, zkuste to znovu za pár minut.
    </div>
    </div>*@
@section breadcrumb
{
<ol class="breadcrumb">
    <li><a href="/">Hlídač Státu</a></li>
    <li><a href="@Url.Action("Index","StatniWeby")">Hlídač Webů</a></li>
    <li class="active">Dostupnost nejdůležitějších webů</li>
</ol>
}
<partial name="~/Views/StatniWeby/_Info.cshtml" model="@ViewData" />

<h2>Dostupnost nejdůležitějších služeb <small>za posledních 24 hodin</small></h2>
<div class="row">
    <div class="col-sm-12">
        @WebyChartUtil.Chart("index", 48, 700, false)
    </div>
</div>


@{
    var data = HlidacStatu.Repositories.UptimeSSLRepo.AllLatestSSL()
            .OrderByDescending(m => m.SSLGrade())
            .ToArray();
}
@if (data != null)
{
    var servers = HlidacStatu.Repositories.UptimeServerRepo.AllActiveServers();
    var expired = data.Where(m => m.CertExpiration() != null).Where(m => (m.CertExpiration().Value - DateTime.Now).TotalDays < 0);
    var closeToExpiration = data
        .Where(m => m.CertExpiration() != null)
        .Where(m => (m.CertExpiration().Value - DateTime.Now).TotalDays > 0)
        .OrderBy(o => o.CertExpiration());

    <h3 style="margin-top:20px;">Časová platnost HTTPs certifikátů</h3>
    <div class="row">
        <div class="col-xs-12">
            @if (expired.Count() > 0)
            {
                <div class="card">
                    <div class="card-header">
                        Již neplatné (expirované certifikáty)
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <ul class="list-inline">
                                @foreach (var domain in expired)
                                {
                                    var server = servers.FirstOrDefault(m => m.HostDomain().ToLower() == domain.Domain.ToLower());
                                    TimeSpan interval = domain.CertExpiration().Value - DateTime.Now;
                                    var expiresIn = "Skončila " + Devmasters.DT.Util.Ago(new TimeSpan(-1 * interval.Ticks), HlidacStatu.Util.Consts.czCulture);

                                    <li class="list-inline-item"><i class='fa-solid fa-alarm-exclamation text-danger blinking'></i> <a href="@server.pageUrl">@server.Name</a>.</li>
                                }
                            </ul>
                        </p>
                    </div>
                </div>
                <div style="margin-bottom:20px;"></div>
            }
            @if (closeToExpiration.Count() > 0)
            {
                <div class="card">
                    <div class="card-header">
                        Certifikáty, co budou neplatné do týdne
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <ul class="list-inline">
                                @foreach (var domain in closeToExpiration.Where(m => (m.CertExpiration().Value - DateTime.Now).TotalDays < 8))
                                {
                                    var server = servers.FirstOrDefault(m => m.HostDomain().ToLower() == domain.Domain.ToLower());
                                    TimeSpan interval = domain.CertExpiration().Value - DateTime.Now;
                                    var expiresIn = "Skončí " + Devmasters.DT.Util.Ago(new TimeSpan(-1 * interval.Ticks), HlidacStatu.Util.Consts.czCulture);
                                    string icon = "";
                                    if (interval.TotalDays < 4)
                                    {
                                        icon = "<i class='fa-solid fa-circle-exclamation text-danger'></i>";
                                    }
                                    else
                                    {
                                        icon = "<i class='fa-solid fa-circle-exclamation  text-warning'></i>";
                                    }

                                    <li class="list-inline-item">@Html.Raw(icon) <a href="@server.pageUrl">@server.Name</a> (@expiresIn).</li>
                                }
                            </ul>
                        </p>
                    </div>
                </div>
<a href="/statniweby/htttps"class="btn btn-warning btn-sm">Více informací o HTTPS všech serverů</a>

            }
        </div>
    </div>



}
<div class="clearfix"></div>

@WebyChartUtil.TableNextGroups("index")


<div class="bs-callout bs-callout-primary">
    <h4>Hlídání dostupnosti státní webů. Co to vlastně děláme?</h4>
    <p>
        Měříme každou minutu, zda důležité weby státu vůbec běží, a pokud ano, tak jak rychle odpovídají. A tomu odpovídají i zobrazené barvy.
        Pokud služba odpovídá rychle, dáváme <b style="color:@(UptimeServer.Availability.GetStatusChartColor(UptimeSSL.Statuses.OK))">zelenou - v pořádku</b>.
        Pokud odpovídá déle, dáváme <b style="color:@(UptimeServer.Availability.GetStatusChartColor(UptimeSSL.Statuses.Pomalé))">oranžovou - pomalá odpověď.</b>.
        Pokud neodpoví nebo odpoví za dlouhou dobu, použijeme <b style="color:@(UptimeServer.Availability.GetStatusChartColor(UptimeSSL.Statuses.Nedostupné))">červenou za nedostupnost</b>.
    </p>
    <p>
        <a href="@Url.Action("JakMerime", "StatniWeby")">Podrobný popis měření a hodnocení</a>.
    </p>
</div>



<div class="clearfix"></div>
<p class="text-muted">Údaje na této stránce mohou být až 5 minut staré.</p>



@section footerscripts{
}

