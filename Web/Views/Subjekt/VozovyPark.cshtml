@model HlidacStatu.Entities.Firma 
@using System.Linq;
@using HlidacStatu.RegistrVozidel.Models
@using HlidacStatu.Repositories
@using HlidacStatu.XLib.Render
@using Devmasters;
@using Devmasters.DT;

@{
    Layout = null;

    List<VozidloLight> vozidlaRaw = 
        await HlidacStatu.RegistrVozidel.Repo.Cached.GetForICOAsync(this.Model.ICO);
    List<VozidloLightPerIco> vozidla = vozidlaRaw
        .GroupBy(g => g.Pcv)
        .Select(s => new VozidloLightPerIco(s))
        .ToList();


    ReportDataSource<VozidloLightPerIco> rds = new(
        new[]
{
            new  ReportDataSource<VozidloLightPerIco>.Column() { 
                Name="Značka",
                HtmlRender =(s) => {
                    return s.Tovarni_znacka;
                },
                ValueRender = (s) => { return s.Tovarni_znacka; },
                TextRender = (s) => { return s.Tovarni_znacka; },
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Model",
                HtmlRender =(s) => {
                    return s.Model;
                },
                ValueRender = (s) => { return s.Model; },
                TextRender = (s) => { return s.Model; },
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Kategorie",
                HtmlRender =(s) => {
                    return s.Kategorie.Kod.ShortenMe(2);
                },
                ValueRender = (s) => { return s.Kategorie.Kod.ShortenMe(2); },
                TextRender = (s) => { return s.Kategorie.Kod.ShortenMe(2); },
                CssClass = "d-none d-lg-table-cell"
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Palivo",
                HtmlRender =(s) => {
                    return $"<span title='{s.Palivo}'>{s.Palivo.Trim().ShortenMe(2)}</span>";
                },
                ValueRender = (s) => { return s.Palivo; },
                TextRender = (s) => { return s.Palivo; },
                CssClass = "d-none d-lg-table-cell"
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Rok výroby",
                HtmlRender =(s) => {
                    return s.Rok_vyroby == null ? "&pm;"+s.Datum_1_registrace?.ToString("yyyy") : s.Rok_vyroby.ToString();
                    
                },
                ValueRender = (s) => { return s.Rok_vyroby == null ? s.Datum_1_registrace?.ToString("yyyy") : s.Rok_vyroby.ToString(); },
                TextRender = (s) => { return s.Rok_vyroby == null ? s.Datum_1_registrace?.ToString("yyyy") : s.Rok_vyroby.ToString();},
                OrderValueRender = (s) => { return HlidacStatu.Util.RenderData.OrderValueFormat(s.Rok_vyroby == null ? s.Datum_1_registrace?.Year : s.Rok_vyroby); }
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Majitel",
                HtmlRender =(s) => {
                    return string.Join("<br />", s.Majitel_v_dobe.Select(m=> m.ToNiceString(dateFormat:"yyyy")))
                    + "&nbsp;";
                },
                ValueRender = (s) => { return s.Majitel_v_dobe.LastOrDefault()?.From?.ToString("yyyy"); },
                TextRender = (s) => { return s.Majitel_v_dobe.LastOrDefault()?.From?.ToString("yyyy") ;}
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Provozovatel",
                HtmlRender =(s) => {
                    return string.Join("<br />", s.Provozovatel_v_dobe.Select(m=> m.ToNiceString(dateFormat:"yyyy")))
                        + "&nbsp;";
                },
                ValueRender = (s) => { return s.Provozovatel_v_dobe.LastOrDefault()?.From?.ToString("yyyy"); },
                TextRender = (s) => { return s.Provozovatel_v_dobe.LastOrDefault()?.From?.ToString("yyyy") ;}
            },
            new  ReportDataSource<VozidloLightPerIco>.Column() {
                Name="Detail",
                HtmlRender =(s) => {
                    return $"<a href='/vozidla/vin/{s.VIN}'>Detail</a>";
                },
                ValueRender = (s) => { return s.VIN; },
                TextRender = (s) => { return s.VIN ;},
            },
        });

    rds.AddRows(vozidla.Where(m=>m.Aktualni==true));
}

<div id="subjcontent_toc">

    @if (User.IsInRole("Admin") == false)
    {
        <p>Tato stránka bude dostupná až za několik dní</p>
        return;
    }
    <div class="p-5 border border-3">
    <h2>Test pristupu pro supporters</h2>

    <role-limited roles="Admin,Supporter" hide-any-content="false">
        <pass>
            Jsi admin, zde bys viděl všechna vozidla
            <hr />
            <hidecontent height="70">
                <span>@Html.Raw(string.Join("<br />", vozidla.Select(m=>$"Detail o vozidle {Html.Encode(m.Tovarni_znacka)} {Html.Encode(m.Model)}").Take(2)))
                </span>
            </hidecontent>
            <p class="text-center">
                <partial name="WebUtil/DynamicModal"
                         model="@(new DynamicModalViewModel(
                        $"/api/v1/SupporterOnly",
                        nazevOdkazu: $"<span class='btn btn-hs btn-primary btn-sm my-3 position-relative'>Celý vozový park podrobně <span class='position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger'>" + HlidacStatu.Util.RenderData.NiceNumber(vozidla.Count) + "</span></span>",
                        width: DynamicModalViewModel.WidthSizeEnum.Large
                    ))" />
            </p>
        </pass>
        <else>
        </else>
    </role-limited>
    </div>
    <hr / >
   <h3>Aktuální vozový park</h3>

    @Html.DataToHTMLTable(rds, dataTableOptions: HtmlExtensions.DatatableOptions(pageLength: 20))

    @{
        rds.Clear();
        rds.AddRows(vozidla.Where(m=>m.Aktualni==false));
    }
    <hr />
    <h3>Historický vozový park</h3>
    @Html.DataToHTMLTable(rds, dataTableOptions: HtmlExtensions.DatatableOptions(pageLength: 20, orderColumnIdx:4))


</div>


